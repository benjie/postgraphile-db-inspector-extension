-d pg_phile_starter -h 0.0.0.0
script: scratch.sql
Null display is "[NULL]".
Expanded display is used automatically.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           enabled_roles                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  schema_tree                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 [{"role_name": "pg_monitor", "applicable_roles": [{"grantee": "pg_monitor", "role_name": "pg_read_all_settings", "is_grantable": "NO"}, {"grantee": "pg_monitor", "role_name": "pg_read_all_stats", "is_grantable": "NO"}, {"grantee": "pg_monitor", "role_name": "pg_stat_scan_tables", "is_grantable": "NO"}]}, {"role_name": "pg_read_all_settings", "applicable_roles": null}, {"role_name": "pg_read_all_stats", "applicable_roles": null}, {"role_name": "pg_stat_scan_tables", "applicable_roles": null}, {"role_name": "pg_signal_backend", "applicable_roles": null}, {"role_name": "postgres", "applicable_roles": null}, {"role_name": "app_anonymous", "applicable_roles": null}, {"role_name": "app_user", "applicable_roles": [{"grantee": "app_user", "role_name": "app_anonymous", "is_grantable": "NO"}]}, {"role_name": "app_demon", "applicable_roles": [{"grantee": "app_demon", "role_name": "app_anonymous", "is_grantable": "NO"}]}, {"role_name": "app_admin", "applicable_roles": [{"grantee": "app_admin", "role_name": "app_user", "is_grantable": "NO"}, {"grantee": "app_admin", "role_name": "app_anonymous", "is_grantable": "NO"}]}, {"role_name": "app_tenant_admin", "applicable_roles": [{"grantee": "app_tenant_admin", "role_name": "app_admin", "is_grantable": "NO"}, {"grantee": "app_tenant_admin", "role_name": "app_demon", "is_grantable": "NO"}, {"grantee": "app_tenant_admin", "role_name": "app_anonymous", "is_grantable": "NO"}, {"grantee": "app_tenant_admin", "role_name": "app_user", "is_grantable": "NO"}]}, {"role_name": "app_super_admin", "applicable_roles": [{"grantee": "app_super_admin", "role_name": "app_tenant_admin", "is_grantable": "NO"}, {"grantee": "app_super_admin", "role_name": "app_admin", "is_grantable": "NO"}, {"grantee": "app_super_admin", "role_name": "app_demon", "is_grantable": "NO"}, {"grantee": "app_super_admin", "role_name": "app_anonymous", "is_grantable": "NO"}, {"grantee": "app_super_admin", "role_name": "app_user", "is_grantable": "NO"}]}, {"role_name": "soro", "applicable_roles": null}, {"role_name": "soro_super_admin", "applicable_roles": [{"grantee": "soro_super_admin", "role_name": "soro_admin", "is_grantable": "NO"}, {"grantee": "soro_super_admin", "role_name": "soro_user", "is_grantable": "NO"}, {"grantee": "soro_super_admin", "role_name": "soro_sync", "is_grantable": "NO"}, {"grantee": "soro_super_admin", "role_name": "soro_anonymous", "is_grantable": "NO"}]}, {"role_name": "soro_admin", "applicable_roles": [{"grantee": "soro_admin", "role_name": "soro_user", "is_grantable": "NO"}, {"grantee": "soro_admin", "role_name": "soro_sync", "is_grantable": "NO"}, {"grantee": "soro_admin", "role_name": "soro_anonymous", "is_grantable": "NO"}]}, {"role_name": "soro_user", "applicable_roles": [{"grantee": "soro_user", "role_name": "soro_anonymous", "is_grantable": "NO"}]}, {"role_name": "soro_sync", "applicable_roles": null}, {"role_name": "soro_anonymous", "applicable_roles": null}, {"role_name": "buckfactor", "applicable_roles": null}, {"role_name": "stu_starter", "applicable_roles": null}, {"role_name": "stu_starter_authenticator", "applicable_roles": [{"grantee": "stu_starter_authenticator", "role_name": "stu_starter_visitor", "is_grantable": "NO"}]}, {"role_name": "stu_starter_visitor", "applicable_roles": null}, {"role_name": "graphile_starter", "applicable_roles": null}, {"role_name": "graphile_starter_authenticator", "applicable_roles": [{"grantee": "graphile_starter_authenticator", "role_name": "graphile_starter_visitor", "is_grantable": "NO"}]}, {"role_name": "graphile_starter_visitor", "applicable_roles": null}] | [{"id": "schema:org_fn", "sql_path": null, "schema_name": "org_fn", "catalog_name": "pg_phile_starter", "schema_owner": "postgres", "schema_tables": [], "schema_functions": [{"id": "function:org_fn.current_app_user_contact", "definition": "CREATE OR REPLACE FUNCTION org_fn.current_app_user_contact()\n RETURNS org.contact\n LANGUAGE plpgsql\n STRICT SECURITY DEFINER\nAS $function$\ndeclare\n  _app_user auth.app_user;\n  _contact org.contact;\nbegin\n  _app_user := (SELECT auth_fn.current_app_user());\n\n  SELECT *\n  INTO _contact\n  FROM org.contact\n  WHERE id = (select contact_id from org.contact_app_user where app_user_id = _app_user.id);\n\n  RETURN _contact;\n\nend;\n$function$\n", "function_name": "current_app_user_contact", "function_schema": "org_fn", "result_data_type": "org.contact", "argument_data_types": ""}, {"id": "function:org_fn.build_location", "definition": "CREATE OR REPLACE FUNCTION org_fn.build_location(_name text, _address1 text, _address2 text, _city text, _state text, _zip text, _lat text, _lon text)\n RETURNS org.location\n LANGUAGE plpgsql\n STRICT SECURITY DEFINER\nAS $function$\ndeclare\n  _app_user auth.app_user;\n  _location org.location;\nbegin\n  _app_user := (SELECT auth_fn.current_app_user());\n\n  INSERT INTO org.location(\n    name\n    ,address1\n    ,address2\n    ,city\n    ,state\n    ,zip\n    ,lat\n    ,lon\n    ,app_tenant_id\n  )\n  SELECT\n    _name\n    ,_address1\n    ,_address2\n    ,_city\n    ,_state\n    ,_zip\n    ,_lat\n    ,_lon\n    ,_app_user.app_tenant_id\n\n  RETURNING *\n  INTO _location\n  ;\n\n  RETURN _location;\n\nend;\n$function$\n", "function_name": "build_location", "function_schema": "org_fn", "result_data_type": "org.location", "argument_data_types": "_name text, _address1 text, _address2 text, _city text, _state text, _zip text, _lat text, _lon text"}, {"id": "function:org_fn.build_organization", "definition": "CREATE OR REPLACE FUNCTION org_fn.build_organization(_name text, _external_id text)\n RETURNS org.organization\n LANGUAGE plpgsql\n STRICT SECURITY DEFINER\nAS $function$\ndeclare\n  _app_user auth.app_user;\n  _organization org.organization;\nbegin\n  _app_user := (SELECT auth_fn.current_app_user());\n\n  SELECT *\n  INTO _organization\n  FROM org.organization\n  WHERE (name = _name AND app_tenant_id = _app_user.app_tenant_id)\n  OR (external_id = _external_id AND app_tenant_id = _app_user.app_tenant_id);\n\n  IF _organization.id IS NULL THEN\n    INSERT INTO org.organization(\n      name\n      ,external_id\n      ,app_tenant_id\n    )\n    SELECT\n      _name\n      ,_external_id\n      ,_app_user.app_tenant_id\n    RETURNING *\n    INTO _organization\n    ;\n  END IF;\n\n  RETURN _organization;\n\nend;\n$function$\n", "function_name": "build_organization", "function_schema": "org_fn", "result_data_type": "org.organization", "argument_data_types": "_name text, _external_id text"}, {"id": "function:org_fn.build_contact", "definition": "CREATE OR REPLACE FUNCTION org_fn.build_contact(_first_name text, _last_name text, _email text, _cell_phone text, _office_phone text, _title text, _nickname text, _external_id text, _organization_id bigint)\n RETURNS org.contact\n LANGUAGE plpgsql\n STRICT SECURITY DEFINER\nAS $function$\n  declare\n    _app_user auth.app_user;\n    _app_tenant_id bigint;\n    _contact org.contact;\n    _organization org.organization;\n  begin\n    _app_user := auth_fn.current_app_user();\n\n    SELECT *\n    INTO _organization\n    FROM org.organization\n    WHERE id = _organization_id;\n\n    IF _organization.id IS NULL THEN\n      RAISE EXCEPTION 'No organization exists for id: %', _organization_id;\n    END IF;\n\n    SELECT *\n    INTO _contact\n    FROM org.contact\n    WHERE (email = _email AND app_tenant_id = _app_user.app_tenant_id)\n    OR (external_id = _external_id AND app_tenant_id = _app_user.app_tenant_id);\n\n    IF _contact.id IS NULL THEN\n      INSERT INTO org.contact(\n        first_name\n        ,last_name\n        ,email\n        ,cell_phone\n        ,office_phone\n        ,title\n        ,nickname\n        ,organization_id\n        ,app_tenant_id\n      )\n      SELECT\n        _first_name\n        ,_last_name\n        ,_email\n        ,_cell_phone\n        ,_office_phone\n        ,_title\n        ,_nickname\n        ,_organization_id\n        ,_organization.app_tenant_id\n      RETURNING *\n      INTO _contact;\n    END IF;\n\n    RETURN _contact;\n\n  end;\n  $function$\n", "function_name": "build_contact", "function_schema": "org_fn", "result_data_type": "org.contact", "argument_data_types": "_first_name text, _last_name text, _email text, _cell_phone text, _office_phone text, _title text, _nickname text, _external_id text, _organization_id bigint"}, {"id": "function:org_fn.build_tenant_organization", "definition": "CREATE OR REPLACE FUNCTION org_fn.build_tenant_organization(_name text, _identifier text, _primary_contact_email text, _primary_contact_first_name text, _primary_contact_last_name text)\n RETURNS org.organization\n LANGUAGE plpgsql\n STRICT SECURITY DEFINER\nAS $function$\ndeclare\n  _app_tenant auth.app_tenant;\n  _app_user auth.app_user;\n  _organization org.organization;\n  _primary_contact org.contact;\nbegin\n\n  _app_tenant := auth_fn.build_app_tenant(\n    _name\n    ,_identifier\n  );\n\n  SELECT *\n  INTO _app_user\n  FROM auth.app_user\n  WHERE app_tenant_id = _app_tenant.id\n  AND username = _primary_contact_email\n  ;\n\n  IF _app_user.id IS NULL THEN\n    _app_user := auth_fn.build_app_user(\n        _app_tenant.id\n        ,_primary_contact_email\n        ,'badpassword'\n        ,_primary_contact_email\n        ,'Admin'\n      )\n    ;\n  END IF;\n\n  SELECT *\n  INTO _organization\n  FROM org.organization\n  WHERE name = _name\n  AND app_tenant_id = _app_tenant.id\n  ;\n\n  IF _organization.id IS NULL THEN\n    INSERT INTO\n    org.organization(\n      name\n      ,external_id\n      ,app_tenant_id\n      ,actual_app_tenant_id\n    )\n    SELECT\n      _name\n      ,_identifier\n      ,_app_tenant.id\n      ,_app_tenant.id\n    RETURNING *\n    INTO _organization;\n  END IF;\n\n  UPDATE auth.app_tenant\n  SET identifier = _organization.id\n  WHERE id = _app_tenant.id\n  RETURNING *\n  INTO _app_tenant\n  ;\n\n  SELECT *\n  INTO _primary_contact\n  FROM org.contact\n  WHERE organization_id = _organization.id\n  AND email = _primary_contact_email;\n\n  IF _primary_contact.id IS NULL THEN\n    _primary_contact := org_fn.build_contact(\n      _primary_contact_first_name\n      ,_primary_contact_last_name\n      ,_primary_contact_email\n      ,''\n      ,''\n      ,''\n      ,''\n      ,''\n      ,_organization.id\n    );\n\n    INSERT INTO org.contact_app_user(contact_id, app_user_id, app_tenant_id, username)\n    SELECT _primary_contact.id, _app_user.id, _app_tenant.id, _app_user.username\n    ON conflict do nothing\n    ;\n  END IF;\n\n  RETURN _organization;\n\nend;\n$function$\n", "function_name": "build_tenant_organization", "function_schema": "org_fn", "result_data_type": "org.organization", "argument_data_types": "_name text, _identifier text, _primary_contact_email text, _primary_contact_first_name text, _primary_contact_last_name text"}, {"id": "function:org_fn.build_contact_location", "definition": "CREATE OR REPLACE FUNCTION org_fn.build_contact_location(_contact_id bigint, _name text, _address1 text, _address2 text, _city text, _state text, _zip text, _lat text, _lon text)\n RETURNS org.contact\n LANGUAGE plpgsql\n STRICT SECURITY DEFINER\nAS $function$\n  declare\n    _app_user auth.app_user;\n    _contact org.contact;\n    _location org.location;\n  begin\n    _app_user := auth_fn.current_app_user();\n    \n    SELECT *\n    INTO _contact\n    FROM org.contact c\n    WHERE id = _contact_id\n    AND auth_fn.app_user_has_access(c.app_tenant_id)\n    ;\n\n    IF _contact.id IS NULL THEN\n      RAISE EXCEPTION 'No contact for id: %', _contact_id;\n    END IF;\n\n    IF _contact.location_id IS NULL THEN\n      _location := org_fn.build_location(\n        _name\n        ,_address1\n        ,_address2\n        ,_city\n        ,_state\n        ,_zip\n        ,_lat\n        ,_lon\n      );\n\n      UPDATE org.contact c\n      SET location_id = _location.id\n      WHERE id = _contact_id\n      RETURNING *\n      INTO _contact\n      ;\n    ELSE\n      _location := org_fn.modify_location(\n        _contact.location_id\n        ,_name\n        ,_address1\n        ,_address2\n        ,_city\n        ,_state\n        ,_zip\n        ,_lat\n        ,_lon\n      )\n      ;\n    END IF;\n\n    RETURN _contact;\n\n  end;\n  $function$\n", "function_name": "build_contact_location", "function_schema": "org_fn", "result_data_type": "org.contact", "argument_data_types": "_contact_id bigint, _name text, _address1 text, _address2 text, _city text, _state text, _zip text, _lat text, _lon text"}, {"id": "function:org_fn.build_organization_location", "definition": "CREATE OR REPLACE FUNCTION org_fn.build_organization_location(_organization_id bigint, _name text, _address1 text, _address2 text, _city text, _state text, _zip text, _lat text, _lon text)\n RETURNS org.organization\n LANGUAGE plpgsql\n STRICT SECURITY DEFINER\nAS $function$\n  declare\n    _app_user auth.app_user;\n    _organization org.organization;\n    _location org.location;\n  begin\n    _app_user := auth_fn.current_app_user();\n    \n    SELECT *\n    INTO _organization\n    FROM org.organization o\n    WHERE id = _organization_id\n    AND auth_fn.app_user_has_access(o.app_tenant_id)\n    ;\n\n    IF _organization.id IS NULL THEN\n      RAISE EXCEPTION 'No organization for id: %', _organization_id;\n    END IF;\n    \n    IF _organization.location_id IS NULL THEN\n      _location := org_fn.build_location(\n        _name\n        ,_address1\n        ,_address2\n        ,_city\n        ,_state\n        ,_zip\n        ,_lat\n        ,_lon\n      );\n\n      UPDATE org.organization\n      SET location_id = _location.id\n      WHERE id = _organization_id\n      RETURNING *\n      INTO _organization\n      ;\n    ELSE\n      _location := org_fn.modify_location(\n        _organization.location_id\n        ,_name\n        ,_address1\n        ,_address2\n        ,_city\n        ,_state\n        ,_zip\n        ,_lat\n        ,_lon\n      )\n      ;\n    END IF;\n\n    RETURN _organization;\n\n  end;\n  $function$\n", "function_name": "build_organization_location", "function_schema": "org_fn", "result_data_type": "org.organization", "argument_data_types": "_organization_id bigint, _name text, _address1 text, _address2 text, _city text, _state text, _zip text, _lat text, _lon text"}, {"id": "function:org_fn.modify_location", "definition": "CREATE OR REPLACE FUNCTION org_fn.modify_location(_id bigint, _name text, _address1 text, _address2 text, _city text, _state text, _zip text, _lat text, _lon text)\n RETURNS org.location\n LANGUAGE plpgsql\n STRICT SECURITY DEFINER\nAS $function$\ndeclare\n  _app_user auth.app_user;\n  _location org.location;\nbegin\n  _app_user := (SELECT auth_fn.current_app_user());\n\n  SELECT *\n  INTO _location\n  FROM org.location\n  WHERE id = _id\n  AND auth_fn.app_user_has_access(app_tenant_id)\n  ;\n\n  IF _location.id IS NULL THEN\n    RAISE EXCEPTION 'No location for id: %', _id;\n  END IF;\n\n  UPDATE org.location\n  SET\n    name = _name\n    ,address1 = _address1\n    ,address2 = _address2\n    ,city = _city\n    ,state = _state\n    ,zip = _zip\n    ,lat = _lat\n    ,lon = _lon\n  WHERE id = _location.id\n  RETURNING *\n  INTO _location\n  ;\n\n  RETURN _location;\n\nend;\n$function$\n", "function_name": "modify_location", "function_schema": "org_fn", "result_data_type": "org.location", "argument_data_types": "_id bigint, _name text, _address1 text, _address2 text, _city text, _state text, _zip text, _lat text, _lon text"}, {"id": "function:org_fn.build_facility", "definition": "CREATE OR REPLACE FUNCTION org_fn.build_facility(_organization_id bigint, _name text, _external_id text)\n RETURNS org.facility\n LANGUAGE plpgsql\n STRICT SECURITY DEFINER\nAS $function$\n  declare\n    _app_user auth.app_user;\n    _app_tenant_id bigint;\n    _facility org.facility;\n    _organization org.organization;\n  begin\n    _app_user := auth_fn.current_app_user();\n\n    SELECT *\n    INTO _organization\n    FROM org.organization\n    WHERE id = _organization_id;\n\n    IF _organization.id IS NULL THEN\n      RAISE EXCEPTION 'No organization exists for id: %', _organization_id;\n    END IF;\n\n    SELECT *\n    INTO _facility\n    FROM org.facility\n    WHERE (name = _name AND organization_id = _organization_id)\n    OR (external_id = _external_id AND organization_id = _organization_id)\n    ;\n\n    IF _facility.id IS NULL THEN\n      INSERT INTO org.facility(\n        organization_id\n        ,app_tenant_id\n        ,name\n        ,external_id\n      )\n      SELECT\n        _organization_id\n        ,_organization.app_tenant_id\n        ,_name\n        ,_external_id\n      RETURNING *\n      INTO _facility;\n    END IF;\n\n    RETURN _facility;\n\n  end;\n  $function$\n", "function_name": "build_facility", "function_schema": "org_fn", "result_data_type": "org.facility", "argument_data_types": "_organization_id bigint, _name text, _external_id text"}, {"id": "function:org_fn.build_facility_location", "definition": "CREATE OR REPLACE FUNCTION org_fn.build_facility_location(_facility_id bigint, _name text, _address1 text, _address2 text, _city text, _state text, _zip text, _lat text, _lon text)\n RETURNS org.facility\n LANGUAGE plpgsql\n STRICT SECURITY DEFINER\nAS $function$\n  declare\n    _app_user auth.app_user;\n    _facility org.facility;\n    _location org.location;\n  begin\n    _app_user := auth_fn.current_app_user();\n    \n    SELECT *\n    INTO _facility\n    FROM org.facility o\n    WHERE id = _facility_id\n    AND auth_fn.app_user_has_access(o.app_tenant_id)\n    ;\n\n    IF _facility.id IS NULL THEN\n      RAISE EXCEPTION 'No facility for id: %', _facility_id;\n    END IF;\n    \n    IF _facility.location_id IS NULL THEN\n      _location := org_fn.build_location(\n        _name\n        ,_address1\n        ,_address2\n        ,_city\n        ,_state\n        ,_zip\n        ,_lat\n        ,_lon\n      );\n\n      UPDATE org.facility\n      SET location_id = _location.id\n      WHERE id = _facility_id\n      RETURNING *\n      INTO _facility\n      ;\n    ELSE\n      _location := org_fn.modify_location(\n        _facility.location_id\n        ,_name\n        ,_address1\n        ,_address2\n        ,_city\n        ,_state\n        ,_zip\n        ,_lat\n        ,_lon\n      )\n      ;\n    END IF;\n\n    RETURN _facility;\n\n  end;\n  $function$\n", "function_name": "build_facility_location", "function_schema": "org_fn", "result_data_type": "org.facility", "argument_data_types": "_facility_id bigint, _name text, _address1 text, _address2 text, _city text, _state text, _zip text, _lat text, _lon text"}], "default_character_set_name": null, "default_character_set_schema": null, "default_character_set_catalog": null}]
(1 row)

